@page "/"
@layout BaseLayout
@inject NavigationManager navigationManager
@inject HistoryService History
@inject ISnackbar Snackbar
@inject AuthService AuthService

<MudPaper Elevation="5" Class="d-flex flex-column pa-6 ma-auto" Style="border-radius:15px !important; max-width:400px; margin-top:100px; ">
    <MudAvatar Class="mx-auto mb-4" Style="width:170px;height:170px;">
        <MudImage Src="images/DCBSAAS.jpeg"
                  Class="mx-auto mb-4" />
    </MudAvatar>

    <MudTextField @bind-Value="Username" Label="Kullanıcı Adı" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Person" />
    <MudTextField @bind-Value="Password" Label="Şifre" Variant="Variant.Outlined" InputType="InputType.Password" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Lock" Class="mt-4" />

    <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Success" Class="mt-6" OnClick="LoginAsync" FullWidth="true">
        <MudIcon Icon="@Icons.Material.Filled.Login" Class="mr-2" />
        Giriş
    </MudButton>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mt-4">@ErrorMessage</MudAlert>
    }
</MudPaper>


@code {
    private string? Username { get; set; }
    private string? Password { get; set; }
    private string? ErrorMessage { get; set; }

    public User user { get; set; } 

    private async Task LoginAsync()
    {
        var success = await AuthService.LoginAsync(Username, Password);
        if (success)
        {
            user =  AuthService.GetCurrentUser(Username);
            Snackbar.Add("Giriş Yaptınız.", Severity.Success);
            navigationManager.NavigateTo($"/home?role={user.Role}&name={user.Username}");
        }
        else
        {
            ErrorMessage = "Kullanıcı adı veya şifre hatalı!";
            Snackbar.Add("Giriş Başarısız!", Severity.Error);
        }
    }
}
